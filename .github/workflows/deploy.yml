name: Deploy to Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1. Download code from GitHub to the Runner's workspace
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Sync files to the live folder
      - name: Sync Files to Live Folder
        run: |
          mkdir -p /var/www/sourcepoint/Source-Point
          
          # Add --exclude='actions-runner' to protect your runner files
          rsync -av --delete \
            --exclude='.git' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='actions-runner' \
            ./ /var/www/sourcepoint/Source-Point/

      # 3. Rebuild and Restart Docker containers
      - name: Rebuild Application
        run: |
          cd /var/www/sourcepoint/Source-Point
          # Rebuilds the images and restarts containers in the background
          docker compose up -d --build

      # 4. Database Migrations
      - name: Run Database Migrations
        run: |
          cd /var/www/sourcepoint/Source-Point
          # Runs migrations inside the 'web' container
          # Note: This will now connect to 'localhost' on your laptop because of network_mode: host
          docker compose exec -T web flask db upgrade

      # 5. Cleanup
      - name: Cleanup Old Images
        run: |
          # Removes old, unused Docker images to save disk space on your laptop
          docker image prune -f
