name: Deploy to Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1. This step Authenticates & Downloads code to a temp folder (SUCCESS)
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Sync the downloaded code to your live folder
      # We use rsync to update only changed files (Faster & Safer than git pull here)
      - name: Sync Files to Live Folder
        run: |
          # Create folder if missing
          mkdir -p /var/www/sourcepoint/Source-Point
          
          # Copy files from Runner -> Live Server
          # -a: preserve permissions, -v: verbose, --delete: remove deleted files
          # --exclude: don't copy .git folder or venv to avoid messing up local configs
          rsync -av --exclude='.git' --exclude='venv' --exclude='__pycache__' ./ /var/www/sourcepoint/Source-Point/

      # 3. Rebuild Docker
      - name: Rebuild Application
        run: |
          cd /var/www/sourcepoint/Source-Point
          docker compose up -d --build --no-deps web

      # 4. Database Migrations
      - name: Run Database Migrations
        run: |
          cd /var/www/sourcepoint/Source-Point
          docker compose exec -T web flask db upgrade

      # 5. Cleanup
      - name: Cleanup Old Images
        run: |
          docker image prune -f
