{% extends "layout.html" %}
{% block title %}Candidate Portal{% endblock %}
{% block content %}

<style>
    .rich-text-content ul {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .rich-text-content ol {
        list-style-type: decimal;
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .rich-text-content li {
        margin-bottom: 0.25rem;
    }

    .rich-text-content p {
        margin-bottom: 0.75rem;
    }

    .rich-text-content strong {
        color: #e2e8f0;
        /* Light gray for dark mode */
        font-weight: 700;
    }
</style>

<div class="space-y-8 animate-dynamic">

    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Candidate Portal</h1>
            <p class="text-gray-400 text-sm mt-1">Track applications and showcase your skills.</p>
        </div>

        {% if current_user.meeting_link %}
        <a href="{{ current_user.meeting_link }}" target="_blank"
            class="group relative flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl overflow-hidden shadow-lg shadow-indigo-500/30 transition-all hover:scale-[1.02]">
            <div
                class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-500 ease-out -skew-x-12 origin-left">
            </div>
            <div class="mr-4 bg-white/20 p-2 rounded-full animate-pulse">
                <i class="fas fa-video text-white"></i>
            </div>
            <div class="text-left">
                <p class="text-xs text-indigo-200 font-bold uppercase tracking-wider">Action Required</p>
                <p class="text-sm font-bold text-white">Join Interview Session &rarr;</p>
            </div>
        </a>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-2 space-y-6">
            <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-full">
                <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <h2 class="font-bold text-white flex items-center">
                        <i class="fas fa-briefcase text-emerald-400 mr-3"></i> Open Positions
                    </h2>
                    <span
                        class="px-2.5 py-1 rounded-md bg-emerald-500/10 text-emerald-400 text-xs font-bold border border-emerald-500/20">
                        {{ open_jobs|length }} Active
                    </span>
                </div>

                <div class="p-6 grid gap-4">
                    {% for job in open_jobs %}
                    <div
                        class="group relative bg-black/20 hover:bg-white/5 border border-white/5 hover:border-emerald-500/30 rounded-xl p-5 transition-all duration-300">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-4">
                                <h3 onclick="toggleDescription('{{ job.id }}')"
                                    class="cursor-pointer text-lg font-bold text-white group-hover:text-emerald-300 transition-colors flex items-center gap-2 select-none">
                                    {{ job.title }}
                                    <i id="icon-{{ job.id }}"
                                        class="fas fa-chevron-down text-xs text-gray-500 transition-transform duration-300"></i>
                                </h3>

                                <div id="desc-{{ job.id }}"
                                    class="rich-text-content text-sm text-gray-400 mt-1 line-clamp-2 transition-all duration-300 cursor-pointer"
                                    onclick="toggleDescription('{{ job.id }}')">
                                    {{ job.description | safe }}
                                </div>

                                <div class="flex items-center gap-4 mt-3 text-xs text-gray-500 font-mono">
                                    <span><i class="fas fa-hashtag mr-1"></i>{{ job.job_id[:8] }}</span>
                                    <span><i class="far fa-clock mr-1"></i>{{ job.created_at.strftime('%b %d') }}</span>
                                </div>
                            </div>

                            <div class="ml-4 flex-shrink-0">
                                {% if job.id in applied_job_ids %}
                                <span
                                    class="inline-flex items-center px-3 py-1.5 rounded-lg bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 text-xs font-bold">
                                    <i class="fas fa-check-circle mr-1.5"></i> Applied
                                </span>
                                {% else %}
                                <button onclick="openApplyModal('{{ job.id }}', '{{ job.title }}')"
                                    class="inline-flex items-center px-4 py-2 rounded-lg bg-white/5 hover:bg-emerald-600 text-white text-xs font-bold border border-white/10 hover:border-emerald-500 transition-all">
                                    Apply Now <i
                                        class="fas fa-arrow-right ml-2 opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div
                            class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-800 mb-4 text-gray-600">
                            <i class="fas fa-search text-2xl"></i>
                        </div>
                        <p class="text-gray-400">No open positions at the moment.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="space-y-6">

            <!-- MCQ Tests Card -->
            <div class="glass-panel rounded-xl p-6 border-l-4 border-purple-500">
                <h2 class="font-bold text-white mb-4 flex items-center text-sm uppercase tracking-wide">
                    <i class="fas fa-clipboard-question text-purple-400 mr-2"></i> MCQ Tests
                </h2>
                <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                    {% if mcq_assignments %}
                    {% for assignment in mcq_assignments %}
                    <div
                        class="p-3 rounded-lg bg-white/5 border border-white/5 hover:border-purple-500/30 transition-all">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 overflow-hidden">
                                <p class="text-sm font-semibold text-gray-200 truncate">{{ assignment.test.title }}</p>
                                <p class="text-[10px] text-gray-500 mt-0.5">
                                    <i class="far fa-clock mr-1"></i>{{ assignment.test.duration_minutes }} mins
                                    <span class="mx-1">â€¢</span>
                                    {{ assignment.test.question_count }} questions
                                </p>
                                <p class="text-[10px] text-gray-400 mt-1">
                                    Start: {{ assignment.scheduled_start_time.strftime('%b %d, %I:%M %p') }}
                                </p>
                            </div>
                            <div class="flex-shrink-0">
                                {% if assignment.status == 'completed' %}
                                <a href="{{ url_for('candidate_mcq.view_result', assignment_id=assignment.id) }}"
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/10 border border-green-500/20 text-green-400 text-[10px] font-bold uppercase tracking-wider hover:bg-green-500/20 transition-all">
                                    <i class="fas fa-check-circle"></i> View Result
                                </a>
                                {% elif assignment.status == 'in_progress' %}
                                <a href="{{ url_for('candidate_mcq.start_test', assignment_id=assignment.id) }}"
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-yellow-500/10 border border-yellow-500/20 text-yellow-400 text-[10px] font-bold uppercase tracking-wider hover:bg-yellow-500/20 transition-all">
                                    <i class="fas fa-play-circle"></i> Continue
                                </a>
                                {% elif assignment.status == 'expired' %}
                                <div
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-red-500/10 border border-red-500/20 text-red-400 text-[10px] font-bold uppercase tracking-wider">
                                    <i class="fas fa-times-circle"></i> Expired
                                </div>
                                {% else %}
                                <a href="{{ url_for('candidate_mcq.start_test', assignment_id=assignment.id) }}"
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-purple-500/10 border border-purple-500/20 text-purple-400 text-[10px] font-bold uppercase tracking-wider hover:bg-purple-500/20 transition-all">
                                    <i class="fas fa-play-circle"></i> Start Test
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-xs text-gray-500 text-center py-4">No MCQ tests assigned yet.</p>
                    {% endif %}
                </div>
            </div>

            <div class="glass-panel rounded-xl p-6">
                <h2 class="font-bold text-white mb-4 flex items-center text-sm uppercase tracking-wide">
                    <i class="fas fa-file-signature text-indigo-400 mr-2"></i> Application Status
                </h2>
                <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                    {% for app in my_applications %}
                    <div class="p-3 rounded-lg bg-white/5 border border-white/5 flex items-center justify-between">
                        <div class="overflow-hidden">
                            <p class="text-sm font-semibold text-gray-200 truncate">{{ app.job.title }}</p>
                            <p class="text-[10px] text-gray-500">{{ app.applied_at.strftime('%b %d, %Y') }}</p>
                        </div>
                        <div class="flex-shrink-0 ml-2">
                            {% if app.status == 'Selected' %}
                            <div
                                class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase tracking-wider">
                                <i class="fas fa-check-circle"></i> Selected
                            </div>
                            {% elif app.status == 'Rejected' %}
                            <div
                                class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-red-500/10 border border-red-500/20 text-red-400 text-[10px] font-bold uppercase tracking-wider">
                                <i class="fas fa-times-circle"></i> Rejected
                            </div>
                            {% elif app.status == 'Under Review' %}
                            <div
                                class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-bold uppercase tracking-wider">
                                <i class="fas fa-search"></i> Reviewing
                            </div>
                            {% else %}
                            <div
                                class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-yellow-500/10 border border-yellow-500/20 text-yellow-400 text-[10px] font-bold uppercase tracking-wider">
                                <div
                                    class="w-2 h-2 rounded-full border border-yellow-500 border-t-transparent animate-spin">
                                </div> Pending
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <p class="text-xs text-gray-500 text-center py-4">No active applications.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="glass-panel rounded-xl overflow-hidden border border-white/10">
                <div class="bg-[#1e1e1e] px-4 py-2 border-b border-white/10 flex justify-between items-center">
                    <span class="text-xs text-gray-400 font-mono">share_snippet.java</span>
                    <div class="flex space-x-1.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
                    </div>
                </div>
                <div class="p-5 bg-[#1e1e1e]">
                    <form action="{{ url_for('candidate.share_code') }}" method="POST" class="space-y-4">
                        <div>
                            <select name="recipient_id"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-white focus:ring-1 focus:ring-indigo-500 font-mono">
                                <option value="">// Select Recipient...</option>
                                {% for user in messageable_users %}
                                <option value="{{ user.id }}">@{{ user.username }} ({{ user.role }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <textarea name="java_code" rows="6"
                            class="w-full bg-transparent border-0 text-gray-300 font-mono text-xs p-0 focus:ring-0 resize-none placeholder-gray-600"
                            placeholder="public class Solution { ... }"></textarea>
                        <button type="submit"
                            class="w-full py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold font-mono transition-colors">
                            > Execute Share
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="applyModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeApplyModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-[#0f172a] border border-white/10 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">

                <form id="applyForm" method="POST" enctype="multipart/form-data">
                    <div class="p-6 border-b border-white/10 bg-white/5 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-file-upload text-emerald-400"></i> Apply for <span
                                id="modalJobTitle">Job</span>
                        </h3>
                        <button type="button" onclick="closeApplyModal()"
                            class="text-gray-400 hover:text-white transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-6 space-y-4">
                        <p class="text-sm text-gray-300">To complete your application, please attach your resume.</p>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Resume (PDF)</label>
                            <input type="file" name="resume" accept=".pdf"
                                class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-emerald-600 file:text-white hover:file:bg-emerald-500 cursor-pointer">
                        </div>

                        {% if current_user.resume_filename %}
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-gray-500">Or use existing:</span>
                            <a href="{{ current_user.resume_filename }}" target="_blank"
                                class="text-xs text-indigo-400 hover:underline">View Profile Resume</a>
                        </div>
                        {% endif %}
                    </div>

                    <div class="px-6 py-4 bg-black/20 border-t border-white/10 flex justify-end gap-3">
                        <button type="button" onclick="closeApplyModal()"
                            class="px-4 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 transition-all text-sm font-medium">Cancel</button>
                        <button type="submit"
                            class="px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-500/20 transition-all text-sm font-bold">Submit
                            Application</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openApplyModal(jobId, jobTitle) {
        document.getElementById('modalJobTitle').textContent = jobTitle;
        document.getElementById('applyForm').action = "{{ url_for('candidate.apply_job', job_id=0) }}".replace('0', jobId);

        const modal = document.getElementById('applyModal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.transform').classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeApplyModal() {
        const modal = document.getElementById('applyModal');
        modal.querySelector('.transform').classList.remove('scale-100', 'opacity-100');
        modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }

    function toggleDescription(jobId) {
        const descElement = document.getElementById(`desc-${jobId}`);
        const iconElement = document.getElementById(`icon-${jobId}`);

        // Toggle the truncation class
        if (descElement.classList.contains('line-clamp-2')) {
            // Expand
            descElement.classList.remove('line-clamp-2');
            iconElement.classList.add('rotate-180');
            iconElement.classList.add('text-emerald-400');
        } else {
            // Collapse
            descElement.classList.add('line-clamp-2');
            iconElement.classList.remove('rotate-180');
            iconElement.classList.remove('text-emerald-400');
        }
    }
</script>
{% endblock %}