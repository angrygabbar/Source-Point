{% extends "layout.html" %}
{% block title %}Java Code Test{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold text-white mb-6 animate-dynamic">Java Coding Test</h1>
{% if current_user.assigned_problem %}
    <div class="mb-8 bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 animate-dynamic backdrop-blur-sm border border-white/10">
        <h2 class="text-2xl font-bold text-white">{{ current_user.assigned_problem.title }}</h2>
        <p class="mt-2 text-gray-300 whitespace-pre-wrap">{{ current_user.assigned_problem.description }}</p>
    </div>
{% else %}
    <p class="text-lg text-gray-300 mb-6 animate-dynamic" style="animation-delay: 0.1s;">
        No problem has been assigned to you yet. You can use this editor for practice.
    </p>
{% endif %}

<form action="{{ url_for('submit_code_test') }}" method="POST">
    <!-- Hidden input for language, as it's always Java now -->
    <input type="hidden" name="language" value="java">
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Code Editor -->
        <div class="bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 animate-dynamic backdrop-blur-sm border border-white/10" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Code Editor</h2>
                <div class="flex items-center space-x-2">
                    <label for="recipient" class="text-sm font-medium text-gray-300">Submit to:</label>
                    <select name="recipient_id" id="recipient" class="block pl-3 pr-8 py-1 text-base border-gray-600 rounded-md bg-gray-700/50 text-white">
                        {% for user in messageable_users %}
                            <option class="bg-gray-800" value="{{ user.id }}">{{ user.username }} ({{ user.role.title() }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <textarea name="code" id="codeInput" rows="20" class="w-full font-mono text-sm p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900/50 text-gray-300" placeholder="public class Main...">public class Main {
    public static void main(String[] args) {
        // Your code here.
        System.out.println("Hello, Java!");
    }
}</textarea>
            <input type="hidden" name="output" id="outputInput">
        </div>

        <!-- Output Console -->
        <div class="bg-gray-900 text-white rounded-lg shadow-xl p-6 font-mono text-sm animate-dynamic" style="animation-delay: 0.3s;">
            <h2 class="text-2xl font-bold mb-4">Console Output</h2>
            <pre id="outputConsole" class="whitespace-pre-wrap h-96 overflow-y-auto"></pre>
        </div>
    </div>
    <!-- CORRECTED: Removed animation class from this container -->
    <div class="mt-6 flex justify-end space-x-4">
        <button type="button" id="runCodeBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Run Code</button>
        <button type="submit" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Submit Test</button>
    </div>
</form>

<script>
    document.getElementById('runCodeBtn').addEventListener('click', async () => {
        const code = document.getElementById('codeInput').value;
        const outputConsole = document.getElementById('outputConsole');
        const outputInput = document.getElementById('outputInput');
        const runBtn = document.getElementById('runCodeBtn');

        outputConsole.textContent = "Running code...";
        runBtn.disabled = true;
        runBtn.textContent = "Running...";

        try {
            const response = await fetch("{{ url_for('run_code') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const result = await response.json();
            let finalOutput = "";

            // UPDATED: Logic to handle the response from online-java-compiler
            if (result.error) {
                finalOutput += "--- ERROR ---\n" + result.error + "\n\n";
            } else if (result.output) {
                finalOutput += "--- OUTPUT ---\n" + result.output + "\n\n";
            } else {
                finalOutput += "--- STATUS ---\nExecution finished with no output.\n\n";
            }
            
            outputConsole.textContent = finalOutput;
            outputInput.value = finalOutput;

        } catch (error) {
            outputConsole.textContent = "An error occurred while running the code: " + error.message;
        } finally {
            runBtn.disabled = false;
            runBtn.textContent = "Run Code";
        }
    });
</script>
{% endblock %}
