{% extends "layout.html" %}
{% block title %}EMI Operations{% endblock %}
{% block content %}

<div class="animate-dynamic space-y-10 pb-20">
    
    <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-white/5 pb-8">
        <div>
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-white tracking-tight">
                EMI Operations
            </h1>
            <p class="text-gray-400 text-sm mt-2 font-light">
                Centralized scheduling, tracking, and automated reconciliation.
            </p>
        </div>
        
        <div class="flex gap-4">
            <div class="text-right px-4 border-r border-white/10">
                <span class="block text-xs text-gray-500 uppercase font-bold tracking-wider">Active Plans</span>
                <span class="text-xl font-bold text-white">{{ plans|length }}</span>
            </div>
            <div class="text-right pl-2">
                <span class="block text-xs text-gray-500 uppercase font-bold tracking-wider">System Status</span>
                <span class="flex items-center justify-end gap-2 text-xs text-emerald-400 font-bold mt-1">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Auto-Reminders Active
                </span>
            </div>
        </div>
    </div>

    <div class="relative group">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl opacity-20 blur group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative glass-panel p-8 rounded-2xl border border-white/10 shadow-2xl">
            <div class="flex items-center mb-6">
                <div class="h-10 w-10 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400 mr-4 shadow-inner">
                    <i class="fas fa-file-import text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Initialize New Schedule</h3>
                    <p class="text-xs text-gray-400">Upload CSV/PDF to auto-generate installment plans.</p>
                </div>
            </div>

            <form action="{{ url_for('admin_core.import_emi_schedule') }}" method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Lender (Receiver)</label>
                    <div class="relative">
                        <i class="fas fa-arrow-up absolute left-3 top-3.5 text-green-500 text-xs"></i>
                        <select name="lender_id" required class="w-full bg-black/40 border border-white/10 rounded-xl pl-8 pr-4 py-3 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all cursor-pointer hover:bg-white/5 appearance-none">
                            <option value="">Select User...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.role }})</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-600 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Borrower (Payer)</label>
                    <div class="relative">
                        <i class="fas fa-arrow-down absolute left-3 top-3.5 text-red-500 text-xs"></i>
                        <select name="borrower_id" required class="w-full bg-black/40 border border-white/10 rounded-xl pl-8 pr-4 py-3 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all cursor-pointer hover:bg-white/5 appearance-none">
                            <option value="">Select User...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.role }})</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-600 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Reference Title</label>
                    <input type="text" name="title" placeholder="e.g. Q3 Software License" required class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-gray-600 focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
                
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Schedule File</label>
                    <label class="flex items-center justify-center w-full px-4 py-2.5 transition bg-black/40 border-2 border-dashed border-gray-700 rounded-xl appearance-none cursor-pointer hover:border-indigo-500 focus:outline-none group/file">
                        <span class="flex items-center space-x-2">
                            <i class="fas fa-cloud-upload-alt text-gray-400 group-hover/file:text-white transition-colors"></i>
                            <span class="text-sm text-gray-400 group-hover/file:text-white transition-colors">Choose CSV/PDF</span>
                        </span>
                        <input type="file" name="schedule_file" accept=".csv, .pdf" required class="hidden" onchange="this.previousElementSibling.querySelector('span:last-child').innerText = this.files[0].name">
                    </label>
                </div>
                
                <div class="md:col-span-12 flex justify-between items-center border-t border-white/5 pt-4 mt-2">
                    <p class="text-[10px] text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i> Format: Date (YYYY-MM-DD) | Amount | Desc
                    </p>
                    <button type="submit" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition-all transform hover:scale-[1.02] flex items-center">
                        <i class="fas fa-cog fa-spin mr-2 hidden group-active:inline-block"></i> Generate Plan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="space-y-6">
        <h2 class="text-xl font-bold text-white flex items-center">
            <i class="fas fa-list-alt text-gray-500 mr-3"></i> Active Schedules
        </h2>

        {% for plan in plans %}
        {% set paid_amount = plan.payments | selectattr('status', 'equalto', 'Paid') | sum(attribute='amount') %}
        {% set progress = (paid_amount / plan.total_principal * 100) | round if plan.total_principal > 0 else 0 %}

        <div id="plan-{{ plan.id }}" x-data="{ expanded: false }" class="glass-panel rounded-2xl overflow-hidden border border-white/5 hover:border-white/10 transition-all duration-300 shadow-lg">
            
            <div @click="expanded = !expanded" class="p-6 cursor-pointer relative group bg-gradient-to-b from-white/[0.02] to-transparent hover:bg-white/[0.04] transition-colors">
                
                <div class="absolute bottom-0 left-0 h-1 bg-gray-800 w-full">
                    <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-1000 ease-out" style="width: {{ progress }}%"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
                    
                    <div class="md:col-span-4 flex items-center gap-4">
                        <div class="h-12 w-12 rounded-xl bg-gray-800 flex items-center justify-center text-gray-400 border border-white/5 shadow-inner">
                            <span class="font-bold text-sm">{{ progress|int }}%</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg leading-tight">{{ plan.title }}</h3>
                            <p class="text-xs text-gray-500 mt-1">ID: #PLAN-{{ plan.id }} &bull; {{ plan.created_at.strftime('%d %b %Y') }}</p>
                        </div>
                    </div>

                    <div class="md:col-span-4 grid grid-cols-2 gap-4">
                        <div class="bg-black/20 p-2 rounded-lg border border-white/5">
                            <span class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Lender</span>
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                                <span class="text-sm text-gray-200 truncate">{{ plan.lender.username }}</span>
                            </div>
                        </div>
                        <div class="bg-black/20 p-2 rounded-lg border border-white/5">
                            <span class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Borrower</span>
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                <span class="text-sm text-gray-200 truncate">{{ plan.borrower.username }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-4 flex items-center justify-end gap-6">
                        <div class="text-right">
                            <span class="block text-xs text-gray-500 uppercase font-bold">Outstanding / Total</span>
                            <div class="text-white font-mono">
                                <span class="text-gray-400">₹{{ "{:,.0f}".format(paid_amount) }}</span>
                                <span class="text-gray-600 mx-1">/</span>
                                <span class="text-lg font-bold text-emerald-400">₹{{ "{:,.0f}".format(plan.total_principal) }}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 border-l border-white/10 pl-6">
                            <a href="#" 
                               data-url="{{ url_for('admin_core.delete_emi_plan', plan_id=plan.id) }}"
                               class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-red-400 hover:bg-red-500/10 transition-all"
                               @click.stop="handleAjaxUrl($event, $el.dataset.url, 'Delete this plan and all history?')"
                               title="Delete Schedule">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                            <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 text-gray-300 group-hover:bg-white/10 transition-all">
                                <i class="fas fa-chevron-down text-xs transition-transform duration-300" :class="expanded ? 'rotate-180' : ''"></i>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <div x-show="expanded" 
                 x-collapse
                 class="bg-black/20 border-t border-white/5">
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-black/40 text-gray-500 text-[10px] uppercase font-bold tracking-wider">
                            <tr>
                                <th class="px-6 py-3 w-16 text-center">#</th>
                                <th class="px-6 py-3">Due Date</th>
                                <th class="px-6 py-3">Description</th>
                                <th class="px-6 py-3 text-right">Amount</th>
                                <th class="px-6 py-3 text-center">Status</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {% for payment in plan.payments %}
                            <tr class="hover:bg-white/5 transition-colors group/row" id="payment-row-{{ payment.id }}">
                                <td class="px-6 py-4 text-gray-600 text-center font-mono text-xs">
                                    {{ "%02d"|format(payment.installment_number) }}
                                </td>
                                <td class="px-6 py-4">
                                    <span class="text-gray-300 font-medium">{{ payment.due_date.strftime('%d %b, %Y') }}</span>
                                    {% if payment.status != 'Paid' %}
                                        <span class="block text-[10px] text-gray-600 mt-0.5">
                                            {{ (payment.due_date - payment.due_date.today()).days }} days remaining
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-gray-400 text-xs">{{ payment.description }}</td>
                                <td class="px-6 py-4 text-right font-mono font-bold text-white">
                                    ₹{{ "{:,.2f}".format(payment.amount) }}
                                </td>
                                <td class="px-6 py-4 text-center status-cell">
                                    {% if payment.status == 'Paid' %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)]">
                                            <i class="fas fa-check-circle mr-1.5"></i> Paid
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">
                                            <i class="fas fa-clock mr-1.5"></i> Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-right flex items-center justify-end gap-2 action-cell">
                                    <button type="button" 
                                            class="w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 transition-all"
                                            onclick="openEditModal('{{ payment.id }}', '{{ payment.amount }}', '{{ payment.due_date }}', '{{ payment.description }}', '{{ payment.status }}')"
                                            title="Edit Payment">
                                        <i class="fas fa-pen text-xs"></i>
                                    </button>

                                    {% if payment.status != 'Paid' %}
                                    <button type="button" 
                                            data-url="{{ url_for('admin_core.mark_emi_paid', payment_id=payment.id) }}"
                                            onclick="markEmiAsPaid(event, this)"
                                            class="inline-block px-3 py-1.5 bg-blue-600/10 hover:bg-blue-600 hover:text-white text-blue-400 border border-blue-600/30 rounded-lg text-xs font-bold transition-all transform active:scale-95 mark-paid-btn">
                                        Mark Paid
                                    </button>
                                    {% else %}
                                    <span class="text-[10px] text-gray-600 font-mono">
                                        {{ payment.payment_date.strftime('%d/%m') if payment.payment_date else 'Done' }}
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center py-20 glass-panel rounded-2xl border-2 border-dashed border-gray-700/50">
            <div class="h-20 w-20 rounded-full bg-gray-800/50 flex items-center justify-center mb-6 animate-pulse">
                <i class="fas fa-coins text-4xl text-gray-600"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">No Active Schedules</h3>
            <p class="text-gray-400 max-w-md text-center text-sm">
                Get started by initializing a new payment schedule using the panel above. You can upload CSV or PDF files.
            </p>
        </div>
        {% endfor %}
    </div>
</div>

<div id="editPaymentModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-[#0f172a] border border-white/10 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <form action="{{ url_for('admin_core.update_emi_payment') }}" method="POST">
                    <input type="hidden" name="payment_id" id="edit_payment_id">
                    
                    <div class="p-6 border-b border-white/10 bg-white/5 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <div class="p-1.5 rounded-lg bg-blue-500/20 text-blue-400">
                                <i class="fas fa-edit text-sm"></i>
                            </div>
                            Edit Installment
                        </h3>
                        <button type="button" onclick="closeEditModal()" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5">Amount (₹)</label>
                                <input type="number" step="0.01" name="amount" id="edit_amount" required 
                                       class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:ring-1 focus:ring-blue-500 font-mono">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5">Due Date</label>
                                <input type="date" name="due_date" id="edit_date" required 
                                       class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5">Description</label>
                            <input type="text" name="description" id="edit_description" required 
                                   class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:ring-1 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5">Status</label>
                            <select name="status" id="edit_status" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:ring-1 focus:ring-blue-500">
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>

                    <div class="px-6 py-4 bg-black/20 border-t border-white/10 flex justify-end gap-3">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 transition-all text-sm font-medium">Cancel</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/20 transition-all text-sm font-bold">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openEditModal(id, amount, date, desc, status) {
        document.getElementById('edit_payment_id').value = id;
        document.getElementById('edit_amount').value = amount;
        document.getElementById('edit_date').value = date;
        document.getElementById('edit_description').value = desc;
        document.getElementById('edit_status').value = status;
        
        const modal = document.getElementById('editPaymentModal');
        modal.classList.remove('hidden');
        // Animation
        setTimeout(() => {
            modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.transform').classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeEditModal() {
        const modal = document.getElementById('editPaymentModal');
        modal.querySelector('.transform').classList.remove('scale-100', 'opacity-100');
        modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }

    async function markEmiAsPaid(event, btn) {
        if (!confirm('Confirm payment received?')) return;

        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('opacity-50', 'cursor-not-allowed');

        try {
            const response = await fetch(btn.dataset.url, {
                method: 'POST', // Now supported by admin.py
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();

            if (data.success) {
                if (window.showToast) window.showToast(data.message, 'success');
                
                // Find Row components
                const row = btn.closest('tr');
                const statusCell = row.querySelector('.status-cell');
                const actionCell = row.querySelector('.action-cell');
                
                // Update Status Badge
                statusCell.innerHTML = `
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)]">
                        <i class="fas fa-check-circle mr-1.5"></i> Paid
                    </span>
                `;

                // Update Action Cell (Replace button with Date)
                // We keep the edit button but replace the Mark Paid button with the date
                const dateStr = data.payment_date || 'Done';
                const markPaidBtn = row.querySelector('.mark-paid-btn');
                if (markPaidBtn) {
                    markPaidBtn.outerHTML = `<span class="text-[10px] text-gray-600 font-mono">${dateStr}</span>`;
                }

            } else {
                if (window.showToast) window.showToast(data.message, 'error');
                btn.innerHTML = originalContent;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        } catch (e) {
            console.error(e);
            if (window.showToast) window.showToast('Network error', 'error');
            btn.innerHTML = originalContent;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
</script>
{% endblock %}