{% extends "layout.html" %}
{% block title %}Manage Coding Events{% endblock %}
{% block content %}

<div class="mb-10 animate-dynamic">
    <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 mb-2">
        Coding Events Hub
    </h1>
    <p class="text-gray-400 text-lg">Schedule tests, manage problems, and track candidate submissions.</p>
</div>

<div class="space-y-8">

    {% if current_user.role != 'moderator' %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-dynamic" style="animation-delay: 0.1s;">
        
        <div class="bg-white/5 dark:bg-gray-800/40 rounded-xl shadow-lg border border-white/10 backdrop-blur-md overflow-hidden">
            <div class="p-6 border-b border-white/5 bg-gradient-to-r from-blue-900/20 to-transparent">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-code text-blue-400 mr-3"></i> Create Problem
                </h2>
            </div>
            <div class="p-6">
                <form action="{{ url_for('create_problem') }}" method="POST" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Problem Title</label>
                        <input type="text" name="problem_title" placeholder="e.g., Reverse Linked List" required class="w-full px-4 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Description</label>
                        <textarea name="problem_description" rows="4" placeholder="Write the problem statement here..." required class="w-full px-4 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"></textarea>
                    </div>
                    <button type="submit" class="w-full py-2.5 px-4 rounded-lg text-white bg-blue-600 hover:bg-blue-500 font-medium shadow-lg shadow-blue-600/20 transition-all transform hover:scale-[1.02]">
                        <i class="fas fa-plus mr-2"></i> Add Problem
                    </button>
                </form>
            </div>
        </div>

        <div class="bg-white/5 dark:bg-gray-800/40 rounded-xl shadow-lg border border-white/10 backdrop-blur-md overflow-hidden">
            <div class="p-6 border-b border-white/5 bg-gradient-to-r from-green-900/20 to-transparent">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-calendar-alt text-green-400 mr-3"></i> Schedule Test
                </h2>
            </div>
            <div class="p-6">
                <form action="{{ url_for('assign_problem') }}" method="POST" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Candidate</label>
                            <select name="candidate_id" required class="w-full px-3 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white focus:ring-2 focus:ring-green-500">
                                <option value="">Select Candidate</option>
                                {% for candidate in candidates %}
                                    <option value="{{ candidate.id }}">{{ candidate.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Problem</label>
                            <select name="problem_id" required class="w-full px-3 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white focus:ring-2 focus:ring-green-500">
                                <option value="">Select Problem</option>
                                {% for problem in problems %}
                                    <option value="{{ problem.id }}">{{ problem.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Start Time (IST)</label>
                            <input type="datetime-local" name="start_time" required class="w-full px-3 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase mb-1">End Time (IST)</label>
                            <input type="datetime-local" name="end_time" required class="w-full px-3 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Meeting Link</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-video text-gray-500"></i>
                            </div>
                            <input type="url" name="meeting_link" placeholder="https://meet.google.com/..." class="w-full pl-10 pr-3 py-2 rounded-lg bg-gray-900/50 border border-gray-600 text-white focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <button type="submit" class="w-full py-2.5 px-4 rounded-lg text-white bg-green-600 hover:bg-green-500 font-medium shadow-lg shadow-green-600/20 transition-all transform hover:scale-[1.02]">
                        <i class="fas fa-paper-plane mr-2"></i> Assign & Schedule
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-dynamic" style="animation-delay: 0.2s;">
        <div class="bg-white/5 dark:bg-gray-800/40 rounded-xl shadow-lg border border-white/10 backdrop-blur-md flex flex-col">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white flex items-center"><i class="fas fa-clock text-yellow-400 mr-3"></i> Scheduled Events</h2>
                <span class="text-xs bg-white/10 text-gray-300 px-2 py-1 rounded-md">{{ scheduled_events|length }} Active</span>
            </div>
            <div class="p-4 space-y-4 flex-1 overflow-y-auto max-h-[600px] custom-scrollbar">
                {% for event in scheduled_events %}
                    <div class="bg-gray-900/40 border border-white/5 rounded-lg p-4 hover:border-indigo-500/30 transition-colors group relative">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-white text-lg">{{ event.assigned_problem.title }}</h3>
                                <div class="flex items-center text-gray-400 text-sm mt-1">
                                    <i class="fas fa-user-circle mr-2"></i> 
                                    <span class="text-indigo-300 font-medium">{{ event.username }}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="inline-block px-2 py-1 rounded text-xs font-bold bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">SCHEDULED</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm text-gray-300">
                            <div class="bg-black/20 p-2 rounded">
                                <span class="block text-xs text-gray-500 uppercase">Start</span>
                                <span class="font-mono">{{ event.start_time_ist }}</span>
                            </div>
                            <div class="bg-black/20 p-2 rounded">
                                <span class="block text-xs text-gray-500 uppercase">End</span>
                                <span class="font-mono">{{ event.end_time_ist }}</span>
                            </div>
                        </div>

                        <div class="border-t border-white/5 pt-3 mt-3">
                            <div class="flex flex-col gap-2">
                                <form action="{{ url_for('reschedule_event', user_id=event.id) }}" method="POST" class="flex items-center space-x-2 bg-white/5 p-2 rounded-lg">
                                    <input type="datetime-local" name="new_start_time" required class="w-1/2 px-2 py-1 text-xs bg-gray-800 border border-gray-600 rounded text-white focus:ring-1 focus:ring-indigo-500">
                                    <input type="datetime-local" name="new_end_time" required class="w-1/2 px-2 py-1 text-xs bg-gray-800 border border-gray-600 rounded text-white focus:ring-1 focus:ring-indigo-500">
                                    <button type="submit" class="p-1.5 text-yellow-400 hover:text-yellow-300 hover:bg-yellow-400/10 rounded transition-colors" title="Reschedule">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </form>
                                
                                <div class="flex justify-between items-center mt-2">
                                    <a href="{{ url_for('mark_event_completed', user_id=event.id) }}" class="text-xs flex items-center text-blue-400 hover:text-blue-300 transition-colors" onclick="return confirm('Mark this event as manually completed?');">
                                        <i class="fas fa-check-circle mr-1"></i> Mark Completed
                                    </a>
                                    <a href="{{ url_for('cancel_event', user_id=event.id) }}" class="text-xs flex items-center text-red-400 hover:text-red-300 transition-colors" onclick="return confirm('Are you sure you want to cancel this event?');">
                                        <i class="fas fa-ban mr-1"></i> Cancel Event
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-calendar-day text-4xl mb-3 opacity-30"></i>
                        <p>No events currently scheduled.</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white/5 dark:bg-gray-800/40 rounded-xl shadow-lg border border-white/10 backdrop-blur-md flex flex-col">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white flex items-center"><i class="fas fa-history text-purple-400 mr-3"></i> Completed Events</h2>
            </div>
            <div class="p-4 space-y-3 flex-1 overflow-y-auto max-h-[600px] custom-scrollbar">
                {% for event in completed_events %}
                    <div class="bg-gray-900/20 border border-white/5 rounded-lg p-4 flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-white">{{ event.assigned_problem.title }}</h3>
                            <div class="flex items-center text-gray-400 text-sm mt-1">
                                <i class="fas fa-user mr-2"></i> {{ event.username }}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 mb-1">Completed on</div>
                            <div class="font-mono text-sm text-purple-300">{{ event.end_time_ist }}</div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-clipboard-check text-4xl mb-3 opacity-30"></i>
                        <p>No completed events found.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if current_user.role != 'moderator' %}
    <div class="bg-white/5 dark:bg-gray-800/40 rounded-xl shadow-lg border border-white/10 backdrop-blur-md animate-dynamic" style="animation-delay: 0.3s;">
        <div class="p-6 border-b border-white/5">
            <h2 class="text-xl font-bold text-white flex items-center"><i class="fas fa-laptop-code text-pink-400 mr-3"></i> Recent Code Submissions</h2>
        </div>
        <div class="p-6 space-y-6">
            {% for test in received_tests %}
                <div class="bg-gray-900/60 rounded-xl overflow-hidden border border-white/10">
                    <div class="bg-gray-800/50 px-4 py-3 border-b border-white/5 flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div class="h-8 w-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400 font-bold">
                                {{ test.language[0]|upper }}
                            </div>
                            <div>
                                <p class="text-white font-medium">{{ test.candidate_submitter.username }}</p>
                                <p class="text-xs text-gray-400">{{ test.submitted_at.strftime('%b %d, %Y at %I:%M %p') }}</p>
                            </div>
                        </div>
                        <a href="{{ url_for('delete_code_test_submission', submission_id=test.id) }}" class="text-red-400 hover:text-red-300 p-2 transition-colors" title="Delete Submission" onclick="return confirm('Delete this submission?');">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-white/10">
                        <div class="p-4">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-2">Source Code</p>
                            <pre class="text-sm font-mono text-gray-300 overflow-x-auto bg-black/20 p-3 rounded custom-scrollbar max-h-60"><code>{{ test.code }}</code></pre>
                        </div>
                        <div class="p-4">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-2">Output Console</p>
                            <pre class="text-sm font-mono text-green-400 overflow-x-auto bg-black/40 p-3 rounded custom-scrollbar max-h-60 h-full"><code>{{ test.output or 'No output captured.' }}</code></pre>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-10 text-gray-500">
                    <p>No code submissions received yet.</p>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<style>
    /* Custom Scrollbar for internal panels */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.25);
    }
</style>

{% endblock %}