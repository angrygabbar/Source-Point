<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Vision For The Future{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/z53vyzj5hcwj6nlffpeu227p3t1sya9zs5w66nd3qshdjniq/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        /* Global Grid Overlay for Tech Feel */
        .bg-grid-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }
        [x-cloak] { display: none !important; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-transparent text-gray-100 h-full overflow-hidden selection:bg-indigo-500 selection:text-white" hx-boost="false">
    
    <div class="htmx-indicator-bar"></div>
    
    <div class="fixed inset-0 bg-[#00000a] z-[-3]"></div>
    
    <canvas id="bg-canvas" class="fixed top-0 left-0 w-full h-full z-[-2]"></canvas>
    
    <div class="bg-grid-overlay"></div>
    
    <div class="fixed inset-0 bg-gradient-to-b from-transparent via-[#00000a]/30 to-[#00000a] pointer-events-none z-[-1]"></div>

    <div x-data="{ sidebarOpen: false }" class="flex h-full">
        <div x-show="sidebarOpen" @click="sidebarOpen = false" x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/80 z-40 lg:hidden backdrop-blur-sm" style="display: none;"></div>

        {% if current_user.is_authenticated %}
        <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'" class="glass-sidebar fixed inset-y-0 left-0 z-50 w-64 transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 flex flex-col shadow-2xl lg:shadow-none">
            <div class="relative flex items-center justify-center h-20 border-b border-white/5">
                <a hx-get="{{ url_for('seller.seller_dashboard') if current_user.role == 'seller' else url_for('main.dashboard') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center gap-3 cursor-pointer group">
                    <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 group-hover:shadow-indigo-500/40 transition-all">
                        <i class="fas fa-layer-group text-white text-sm"></i>
                    </div>
                    <span class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">SourcePoint</span>
                </a>
                <button @click="sidebarOpen = false" class="absolute right-4 lg:hidden p-2 text-gray-400 hover:text-white transition-colors focus:outline-none"><i class="fas fa-times text-xl"></i></button>
            </div>

            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto custom-scrollbar">
                <div @click="if(window.innerWidth < 1024) sidebarOpen = false">
                    
                    {% if current_user.role != 'seller' %}
                    <a hx-get="{{ url_for('main.dashboard') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 cursor-pointer mb-1 {{ 'bg-white/10 text-white shadow-md border border-white/5' if request.endpoint and 'dashboard' in request.endpoint and 'seller' not in request.endpoint else 'text-gray-400 hover:bg-white/5 hover:text-white' }}">
                        <i class="fas fa-home w-6 text-center mr-2 {{ 'text-indigo-400' if request.endpoint and 'dashboard' in request.endpoint }}"></i> Dashboard
                    </a>
                    {% endif %}

                    <a hx-get="{{ url_for('main.messages') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 cursor-pointer mb-1 {{ 'bg-white/10 text-white shadow-md border border-white/5' if request.endpoint == 'main.messages' else 'text-gray-400 hover:bg-white/5 hover:text-white' }}">
                        <i class="fas fa-comment-dots w-6 text-center mr-2 {{ 'text-indigo-400' if request.endpoint == 'main.messages' }}"></i> Messages
                    </a>

                    {% if current_user.role == 'admin' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Admin Controls</p></div>
                    <a hx-get="{{ url_for('admin_users.manage_users') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-users-cog w-6 text-center mr-2"></i> Users
                    </a>
                    <a hx-get="{{ url_for('admin_core.manage_projects') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-project-diagram w-6 text-center mr-2"></i> Projects
                    </a>
                    <a hx-get="{{ url_for('events.events') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-calendar-alt w-6 text-center mr-2"></i> Events
                    </a>
                    <a hx-get="{{ url_for('admin_core.emi_manager') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-coins w-6 text-center mr-2"></i> Finance
                    </a>
                    <a hx-get="{{ url_for('admin_hiring.manage_records') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-database w-6 text-center mr-2"></i> Records
                    </a>
                    {% endif %}

                    {% if current_user.role == 'developer' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">DevOps</p></div>
                    <a hx-get="{{ url_for('events.events') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-calendar-day w-6 text-center mr-2"></i> Events
                    </a>
                    <a hx-get="{{ url_for('main.learning') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-book w-6 text-center mr-2"></i> Learning Hub
                    </a>
                    {% endif %}

                    {% if current_user.role == 'moderator' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Assessment</p></div>
                    <a hx-get="{{ url_for('events.events') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-calendar-check w-6 text-center mr-2"></i> Events Schedule
                    </a>
                    <a hx-get="{{ url_for('main.learning') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-book w-6 text-center mr-2"></i> Learning Hub
                    </a>
                    {% endif %}

                    {% if current_user.role == 'recruiter' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Hiring</p></div>
                    <a hx-get="{{ url_for('recruiter.recruiter_dashboard') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-user-tie w-6 text-center mr-2"></i> Dashboard
                    </a>
                    <a hx-get="{{ url_for('events.events') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-calendar-alt w-6 text-center mr-2"></i> Events & Tests
                    </a>
                    <a hx-get="{{ url_for('main.learning') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-book w-6 text-center mr-2"></i> Resources
                    </a>
                    {% endif %}

                    {% if current_user.role == 'candidate' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Preparation</p></div>
                    <a hx-get="{{ url_for('main.learning') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-book w-6 text-center mr-2"></i> Learning Hub
                    </a>
                    <a hx-get="{{ url_for('candidate.code_test') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer">
                        <i class="fas fa-code w-6 text-center mr-2"></i> Code Test
                    </a>
                    {% endif %}

                    {% if current_user.role == 'seller' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Seller Tools</p></div>
                    <a hx-get="{{ url_for('seller.seller_dashboard') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer"><i class="fas fa-chart-line w-6 text-center mr-2"></i> Dashboard</a>
                    <a hx-get="{{ url_for('seller.manage_inventory') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer"><i class="fas fa-boxes w-6 text-center mr-2"></i> Inventory</a>
                    <a hx-get="{{ url_for('seller.manage_orders') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer"><i class="fas fa-shopping-cart w-6 text-center mr-2"></i> Orders</a>
                    <a hx-get="{{ url_for('seller.manage_invoices') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer"><i class="fas fa-file-invoice-dollar w-6 text-center mr-2"></i> Invoices</a>
                    {% endif %}

                    {% if current_user.role == 'buyer' %}
                    <div class="pt-6 pb-2"><p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Market</p></div>
                    <a hx-get="{{ url_for('buyer.buyer_dashboard') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer"><i class="fas fa-store w-6 text-center mr-2"></i> Catalog</a>
                    <a hx-get="{{ url_for('buyer.my_orders') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all cursor-pointer"><i class="fas fa-box w-6 text-center mr-2"></i> My Orders</a>
                    {% endif %}
                </div>
            </nav>

            <div class="p-4 border-t border-white/5 bg-black/20">
                <a hx-get="{{ url_for('main.profile') }}" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML transition:true" hx-push-url="true" class="flex items-center w-full p-2 rounded-xl hover:bg-white/5 transition-colors group cursor-pointer border border-transparent hover:border-white/5">
                    <img src="{{ current_user.avatar_url }}" alt="" class="w-10 h-10 rounded-full border border-white/10 group-hover:border-indigo-400 transition-colors object-cover">
                    <div class="ml-3 overflow-hidden">
                        <p class="text-sm font-bold text-white truncate group-hover:text-indigo-300 transition-colors">{{ current_user.username }}</p>
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider truncate">{{ current_user.role }}</p>
                    </div>
                </a>
            </div>
        </aside>
        {% endif %}

        <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <header class="h-20 glass-panel border-b border-white/5 flex items-center justify-between px-6 z-20 relative">
                <div class="flex items-center">
                    {% if current_user.is_authenticated %}
                    <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden text-gray-400 hover:text-white focus:outline-none mr-4 transition-transform active:scale-95"><i class="fas fa-bars text-xl"></i></button>
                    {% else %}
                    <a href="{{ url_for('main.home') }}" class="flex items-center gap-3 group">
                        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 group-hover:scale-105 transition-transform">
                            <i class="fas fa-layer-group text-white text-sm"></i>
                        </div>
                        <span class="text-lg font-bold text-white tracking-tight">SourcePoint</span>
                    </a>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-6">
                    {% if not current_user.is_authenticated %}
                        <a href="{{ url_for('main.home') }}" class="text-sm font-medium text-gray-400 hover:text-white transition-colors hidden sm:block">Home</a>
                        <a href="{{ url_for('main.offers') }}" class="text-sm font-medium text-gray-400 hover:text-white transition-colors hidden sm:block">Offers</a>
                        <a href="{{ url_for('auth.login_register') }}" class="px-5 py-2.5 rounded-xl bg-white hover:bg-gray-100 text-black text-sm font-bold shadow-lg shadow-white/10 transition-all transform hover:-translate-y-0.5">Login</a>
                    {% else %}
                        <a href="{{ url_for('auth.logout') }}" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-red-500/20 border border-white/5 hover:border-red-500/50 flex items-center justify-center text-gray-400 hover:text-red-400 transition-all" title="Logout"><i class="fas fa-power-off"></i></a>
                    {% endif %}
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4 sm:p-8 relative scroll-smooth custom-scrollbar" id="main-content">
                <div id="flash-container" class="fixed top-24 right-6 z-50 space-y-3 pointer-events-none">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="pointer-events-auto flex items-center w-full max-w-sm p-4 text-gray-200 bg-[#1a1a1f]/95 rounded-xl shadow-2xl border border-white/10 backdrop-blur-md animate-fade-in" role="alert">
                                    <div class="inline-flex items-center justify-center flex-shrink-0 w-10 h-10 rounded-lg {{ 'bg-emerald-500/10 text-emerald-400' if category == 'success' else 'bg-red-500/10 text-red-400' }}">
                                        <i class="fas {{ 'fa-check-circle' if category == 'success' else 'fa-exclamation-circle' }}"></i>
                                    </div>
                                    <div class="ml-4 text-sm font-medium">{{ message }}</div>
                                    <button type="button" class="ml-auto -mx-1.5 -my-1.5 text-gray-500 hover:text-white rounded-lg p-1.5 inline-flex h-8 w-8 transition-colors" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <script>
        // --- 1. Notification Management (Auto-Dismiss 3s) ---
        function initFlashMessages() {
            const alerts = document.querySelectorAll('#flash-container [role="alert"]');
            alerts.forEach(alert => {
                if (alert.dataset.timerAttached) return;
                alert.dataset.timerAttached = 'true';

                // Automatically remove after 3 seconds
                setTimeout(() => {
                    alert.style.transition = 'all 0.5s ease-out';
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => alert.remove(), 500);
                }, 3000); 
            });
        }

        // Initialize on load and after HTMX swaps
        document.addEventListener('DOMContentLoaded', initFlashMessages);
        document.addEventListener('htmx:afterSwap', initFlashMessages);

        window.showToast = function(message, category = 'success') {
            const container = document.getElementById('flash-container');
            const div = document.createElement('div');
            div.className = 'pointer-events-auto flex items-center w-full max-w-sm p-4 text-gray-200 bg-[#1a1a1f]/95 rounded-xl shadow-2xl border border-white/10 backdrop-blur-md animate-fade-in';
            div.setAttribute('role', 'alert');
            
            const iconClass = category === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const colorClass = category === 'success' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400';
            
            div.innerHTML = `
                <div class="inline-flex items-center justify-center flex-shrink-0 w-10 h-10 rounded-lg ${colorClass}">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="ml-4 text-sm font-medium">${message}</div>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 text-gray-500 hover:text-white rounded-lg p-1.5 inline-flex h-8 w-8 transition-colors" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
            
            // Auto remove after 3 seconds
            setTimeout(() => { 
                div.style.transition = 'all 0.5s ease-out'; 
                div.style.opacity = '0'; 
                div.style.transform = 'translateX(20px)'; 
                setTimeout(() => div.remove(), 500); 
            }, 3000);
        };

        // --- 2. AJAX Helpers ---
        window.handleAjaxUrl = async function(event, url, confirmMsg = null) {
            event.preventDefault();
            if (confirmMsg && !confirm(confirmMsg)) return;
            const btn = event.currentTarget;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.style.pointerEvents = 'none';
            try {
                const response = await fetch(url, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const data = await response.json();
                if (data.success) {
                    if (window.showToast) window.showToast(data.message, 'success');
                    if (data.remove_row_id) { const row = document.getElementById(data.remove_row_id); if (row) row.remove(); } else { btn.innerHTML = originalContent; btn.style.pointerEvents = 'auto'; }
                } else {
                    if (window.showToast) window.showToast(data.message || 'Action failed', 'error');
                    btn.innerHTML = originalContent; btn.style.pointerEvents = 'auto';
                }
            } catch (e) { console.error(e); if (window.showToast) window.showToast('Network error', 'error'); btn.innerHTML = originalContent; btn.style.pointerEvents = 'auto'; }
        };

        window.handleAjaxForm = async function(event, confirmMsg = null) {
            event.preventDefault();
            if (confirmMsg && !confirm(confirmMsg)) return;
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const data = await response.json();
                if (data.success) {
                    if (window.showToast) window.showToast(data.message, 'success');
                    btn.innerHTML = originalContent; btn.disabled = false;
                } else {
                    if (window.showToast) window.showToast(data.message || 'Action failed', 'error');
                    btn.innerHTML = originalContent; btn.disabled = false;
                }
            } catch (e) { console.error(e); if (window.showToast) window.showToast('Network error', 'error'); btn.innerHTML = originalContent; btn.disabled = false; }
        };

        // --- 3. 3D SOLAR SYSTEM BACKGROUND ---
        if (window.innerWidth > 768) {
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x00000a, 0.00015);

            const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 1, 5000);
            camera.position.set(0, 350, 1100);
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;

            const sunLight = new THREE.PointLight(0xffffff, 2.5, 3000, 1);
            sunLight.position.set(0, 0, 0);
            scene.add(sunLight);
            
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4); 
            scene.add(ambientLight);

            function createStarTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 32; canvas.height = 32;
                const ctx = canvas.getContext('2d');
                const gradient = ctx.createRadialGradient(16,16,0,16,16,16);
                gradient.addColorStop(0, 'rgba(255,255,255,1)');
                gradient.addColorStop(0.2, 'rgba(255,255,255,0.8)');
                gradient.addColorStop(0.5, 'rgba(255,255,255,0.1)');
                gradient.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0,0,32,32);
                return new THREE.CanvasTexture(canvas);
            }
            const starTexture = createStarTexture();

            function createStarField() {
                const starGeo = new THREE.BufferGeometry();
                const starCount = 10000;
                const posArray = new Float32Array(starCount * 3);
                
                for(let i=0; i<starCount * 3; i+=3) {
                    const r = 1000 + Math.random() * 2500; 
                    const theta = 2 * Math.PI * Math.random();
                    const phi = Math.acos(2 * Math.random() - 1);
                    
                    posArray[i] = r * Math.sin(phi) * Math.cos(theta);
                    posArray[i+1] = r * Math.sin(phi) * Math.sin(theta);
                    posArray[i+2] = r * Math.cos(phi);
                }
                
                starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                const starMat = new THREE.PointsMaterial({
                    size: 2.0,
                    map: starTexture, 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8,
                    sizeAttenuation: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending
                });
                
                const starMesh = new THREE.Points(starGeo, starMat);
                return starMesh;
            }

            const starField = createStarField();
            scene.add(starField);

            function createNebulaTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 64;
                const ctx = canvas.getContext('2d');
                const gradient = ctx.createRadialGradient(32,32,0,32,32,32);
                gradient.addColorStop(0, 'rgba(20, 10, 40, 0.4)');
                gradient.addColorStop(0.6, 'rgba(10, 20, 60, 0.1)');
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0,0,64,64);
                return new THREE.CanvasTexture(canvas);
            }
            const nebulaTexture = createNebulaTexture();

            const nebulaGeo = new THREE.BufferGeometry();
            const nebulaCount = 400;
            const nebulaPos = new Float32Array(nebulaCount * 3);
            for(let i=0; i<nebulaCount * 3; i+=3) {
                const r = 800 + Math.random() * 1200;
                const theta = 2 * Math.PI * Math.random();
                const phi = Math.acos(2 * Math.random() - 1);
                nebulaPos[i] = r * Math.sin(phi) * Math.cos(theta);
                nebulaPos[i+1] = r * Math.sin(phi) * Math.sin(theta);
                nebulaPos[i+2] = r * Math.cos(phi);
            }
            nebulaGeo.setAttribute('position', new THREE.BufferAttribute(nebulaPos, 3));
            const nebulaMat = new THREE.PointsMaterial({
                size: 350,
                map: nebulaTexture,
                transparent: true,
                opacity: 0.2,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });
            const nebulaSystem = new THREE.Points(nebulaGeo, nebulaMat);
            scene.add(nebulaSystem);

            const sunGeo = new THREE.SphereGeometry(60, 64, 64);
            const sunMat = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
            const sun = new THREE.Mesh(sunGeo, sunMat);
            scene.add(sun);

            function createGlowTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 64;
                const ctx = canvas.getContext('2d');
                const gradient = ctx.createRadialGradient(32,32,0,32,32,32);
                gradient.addColorStop(0, 'rgba(255, 200, 50, 1)');
                gradient.addColorStop(0.2, 'rgba(255, 160, 0, 0.6)');
                gradient.addColorStop(0.5, 'rgba(255, 100, 0, 0.2)');
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0,0,64,64);
                return new THREE.CanvasTexture(canvas);
            }
            const glowMat = new THREE.SpriteMaterial({ 
                map: createGlowTexture(), 
                color: 0xffaa00, 
                transparent: true, 
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });
            const sunGlow = new THREE.Sprite(glowMat);
            sunGlow.scale.set(350, 350, 1);
            sun.add(sunGlow);

            const planets = [];
            
            function createPlanet(size, color, distance, speed, hasRing = false) {
                const geo = new THREE.SphereGeometry(size, 32, 32);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: color, 
                    roughness: 0.7, 
                    metalness: 0.2
                });
                const mesh = new THREE.Mesh(geo, mat);
                
                const orbitGeo = new THREE.RingGeometry(distance - 0.5, distance + 0.5, 128);
                const orbitMat = new THREE.MeshBasicMaterial({ color: 0xffffff, opacity: 0.08, transparent: true, side: THREE.DoubleSide });
                const orbit = new THREE.Mesh(orbitGeo, orbitMat);
                orbit.rotation.x = Math.PI / 2;
                scene.add(orbit);

                if (hasRing) {
                    const ringGeo = new THREE.RingGeometry(size * 1.4, size * 2.2, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0xcfb096, side: THREE.DoubleSide, transparent: true, opacity: 0.6 });
                    const ringMesh = new THREE.Mesh(ringGeo, ringMat);
                    ringMesh.rotation.x = Math.PI / 2.2;
                    mesh.add(ringMesh);
                }

                scene.add(mesh);
                
                planets.push({ mesh, distance, speed, angle: Math.random() * Math.PI * 2 });
            }

            createPlanet(3, 0xaaaaaa, 100, 0.02);   // Mercury
            createPlanet(5, 0xffcc99, 140, 0.015);  // Venus
            createPlanet(5.5, 0x2233ff, 190, 0.012); // Earth
            createPlanet(4, 0xff4422, 240, 0.01);   // Mars
            createPlanet(18, 0xdcb17d, 340, 0.005); // Jupiter
            createPlanet(15, 0xeeddcc, 450, 0.0035, true); // Saturn
            createPlanet(10, 0x88ccff, 560, 0.002); // Uranus
            createPlanet(10, 0x4466ff, 660, 0.0015); // Neptune

            const clock = new THREE.Clock();

            function animate() {
                const time = clock.getElapsedTime();

                sun.rotation.y += 0.002;

                planets.forEach(p => {
                    p.angle += p.speed * 0.5; 
                    p.mesh.position.x = Math.cos(p.angle) * p.distance;
                    p.mesh.position.z = Math.sin(p.angle) * p.distance;
                    p.mesh.rotation.y += 0.01; 
                });

                starField.rotation.y -= 0.0002; 
                starField.rotation.z += 0.0001; 
                
                nebulaSystem.rotation.y -= 0.00015;

                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    </script>
</body>
</html>