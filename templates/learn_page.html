{% extends "layout.html" %}
{% block title %}Learn {{ language|upper }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 border-b border-white/10 pb-6">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <a href="{{ url_for('main.learning') }}" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <i class="devicon-{{ language }}-plain text-white text-xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white tracking-tight">
                    {{ language|upper }} <span class="text-gray-500 font-normal text-xl">Module</span>
                </h1>
            </div>
            <p class="text-gray-400 text-sm ml-14">Master {{ language|upper }} with our interactive learning path.</p>
        </div>

        {% if current_user.role in ['admin', 'developer'] %}
        <button onclick="toggleEditMode()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/20 transition-all flex items-center gap-2">
            <i class="fas fa-edit"></i> Edit Content
        </button>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <div class="hidden lg:block lg:col-span-1 space-y-6">
            <div class="glass-panel p-5 rounded-xl sticky top-24">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">On This Page</h3>
                <nav id="toc" class="space-y-1 border-l border-white/10 ml-1">
                    </nav>
            </div>
        </div>

        <div class="lg:col-span-3">
            
            <div id="view-content" class="glass-panel p-8 rounded-2xl min-h-[600px] prose prose-invert prose-indigo max-w-none shadow-2xl">
                {{ page_content|safe }}
            </div>

            {% if current_user.role in ['admin', 'developer'] %}
            <div id="edit-content" class="hidden animate-fade-in">
                <form action="{{ url_for('admin_core.update_learning_content') }}" method="POST" class="glass-panel p-6 rounded-2xl border border-white/10">
                    <input type="hidden" name="language_id" value="{{ language }}">
                    
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Editor Mode</h3>
                    </div>

                    <textarea id="editor" name="content" class="w-full h-[500px] bg-black/30 text-white p-4 font-mono text-sm rounded-xl">{{ page_content }}</textarea>

                    <div class="flex justify-end gap-3 pt-4 border-t border-white/10 mt-4">
                        <button type="button" onclick="toggleEditMode()" class="px-5 py-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 font-medium transition-colors">Cancel</button>
                        <button type="submit" class="px-5 py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold shadow-lg shadow-emerald-500/20 transition-all flex items-center gap-2">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<div x-data="{ open: false, question: '', loading: false, chatHistory: [] }" class="fixed bottom-6 right-6 z-50 flex flex-col items-end" x-cloak>
    <div x-show="open" x-transition.scale.origin.bottom.right class="mb-4 w-[350px] sm:w-[400px] h-[500px] bg-[#0f172a] border border-white/10 rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        
        <div class="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 flex justify-between items-center shadow-md shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm"><i class="fas fa-robot text-white text-sm"></i></div>
                <div>
                    <h3 class="font-bold text-white text-sm">AI Tutor</h3>
                    <p class="text-[10px] text-indigo-100 font-medium opacity-90">{{ language|title }} Expert</p>
                </div>
            </div>
            <button @click="open = false" class="text-white/70 hover:text-white"><i class="fas fa-times"></i></button>
        </div>

        <div x-ref="chatContainer" class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-4 bg-[#0b1120]">
            <div class="flex justify-start"><div class="bg-white/10 text-gray-200 text-sm p-3 rounded-2xl rounded-tl-none border border-white/5">ðŸ‘‹ Hi! Ask me anything about {{ language|title }}.</div></div>
            
            <template x-for="(msg, index) in chatHistory" :key="index">
                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white/10 text-gray-200 border border-white/5'" class="text-sm p-3 rounded-2xl max-w-[85%] leading-relaxed" x-html="msg.text"></div>
                </div>
            </template>
            
            <div x-show="loading" class="flex justify-start"><div class="bg-white/5 px-4 py-2 rounded-2xl flex gap-1"><span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-75"></span><span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-150"></span></div></div>
        </div>

        <form @submit.prevent="if(!question.trim()) return; chatHistory.push({role:'user', text:question}); loading=true; const q=question; question=''; $nextTick(()=>$refs.chatContainer.scrollTop=$refs.chatContainer.scrollHeight); fetch('{{ url_for('main.ask_learning_ai') }}', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({question:q, subject:'{{ language }}'})}).then(r=>r.json()).then(d=>{loading=false; chatHistory.push({role:'ai', text:d.answer}); $nextTick(()=>$refs.chatContainer.scrollTop=$refs.chatContainer.scrollHeight)}).catch(()=>{loading=false; chatHistory.push({role:'ai', text:'Error connecting.'})})" class="p-4 bg-[#0f172a] border-t border-white/10 relative">
            <input x-model="question" type="text" placeholder="Ask a question..." class="w-full bg-[#1e293b] border border-white/10 rounded-xl pl-4 pr-12 py-3 text-sm text-white focus:outline-none focus:ring-1 focus:ring-indigo-500" :disabled="loading">
            <button type="submit" :disabled="loading" class="absolute right-6 top-5 text-indigo-400 hover:text-white"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <button @click="open = !open" class="h-14 w-14 rounded-full bg-indigo-600 text-white shadow-xl hover:scale-105 transition-transform flex items-center justify-center text-2xl z-50">
        <i class="fas" :class="open ? 'fa-times' : 'fa-robot'"></i>
    </button>
</div>

<script>
    // Toggle Editor
    function toggleEditMode() {
        const viewDiv = document.getElementById('view-content');
        const editDiv = document.getElementById('edit-content');
        if (editDiv.classList.contains('hidden')) {
            viewDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            if (typeof tinymce !== 'undefined' && !tinymce.get('editor')) {
                tinymce.init({
                    selector: '#editor', height: 500, menubar: false, skin: "oxide-dark", content_css: "dark",
                    plugins: 'lists link code', toolbar: 'undo redo | bold italic | bullist numlist | code'
                });
            }
        } else {
            editDiv.classList.add('hidden');
            viewDiv.classList.remove('hidden');
        }
    }

    // Generate Sidebar TOC
    document.addEventListener('DOMContentLoaded', () => {
        const content = document.getElementById('view-content');
        const toc = document.getElementById('toc');
        const headers = content.querySelectorAll('h2');
        if (headers.length > 0) {
            headers.forEach((header, index) => {
                header.id = 'section-' + index;
                const link = document.createElement('a');
                link.href = '#section-' + index;
                link.className = 'block pl-4 py-1.5 text-sm text-gray-500 hover:text-white hover:border-l-2 hover:border-indigo-500 border-l-2 border-transparent transition-all truncate';
                link.innerText = header.innerText;
                toc.appendChild(link);
            });
        } else {
            toc.innerHTML = '<p class="pl-4 text-xs text-gray-600 italic">No sections found</p>';
        }
    });
</script>
{% endblock %}