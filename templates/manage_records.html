{% extends "layout.html" %}
{% block title %}Manage Records{% endblock %}
{% block content %}
<div class="animate-dynamic">
    <div class="mb-8">
        <h1 class="text-3xl font-extrabold text-white tracking-tight">System Records</h1>
        <p class="text-gray-400 mt-1 text-sm">View and manage historical data logs.</p>
    </div>

    <div class="border-b border-gray-700/50 mb-6">
        <nav class="-mb-px flex space-x-8 overflow-x-auto custom-scrollbar" aria-label="Tabs">
            <button class="tab-link active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-400 border-indigo-500 focus:outline-none transition-colors" data-target="jobs-panel">
                Job Openings
            </button>
            <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-600 focus:outline-none transition-colors" data-target="feedback-panel">
                Candidate Feedback
            </button>
            <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-600 focus:outline-none transition-colors" data-target="submissions-panel">
                Code Submissions
            </button>
            <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-600 focus:outline-none transition-colors" data-target="history-panel">
                Assignment Logs
            </button>
            <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-600 focus:outline-none transition-colors" data-target="events-panel">
                Coding Events
            </button>
        </nav>
    </div>

    <div id="tab-content" class="bg-white/5 dark:bg-gray-800/20 rounded-xl shadow-xl border border-white/10 backdrop-blur-md overflow-hidden min-h-[400px]">
        
        <div id="jobs-panel" class="tab-panel p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3">Title</th>
                            <th class="px-4 py-3 text-center">Status</th>
                            <th class="px-4 py-3">Created On</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for job in jobs %}
                        <tr class="hover:bg-white/5 transition-colors cursor-pointer group" onclick="toggleDetails('job-details-{{ job.id }}')">
                            <td class="px-4 py-4 font-medium text-white">{{ job.title }}</td>
                            <td class="px-4 py-4 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if job.is_open %}bg-green-500/10 text-green-400 border border-green-500/20{% else %}bg-red-500/10 text-red-400 border border-red-500/20{% endif %}">
                                    {{ 'Open' if job.is_open else 'Closed' }}
                                </span>
                            </td>
                            <td class="px-4 py-4 text-gray-400">{{ job.created_at.strftime('%b %d, %Y') }}</td>
                            <td class="px-4 py-4 text-right">
                                <a href="{{ url_for('admin.delete_job_opening', job_id=job.id) }}" class="text-gray-500 hover:text-red-400 transition-colors p-2" title="Delete" onclick="event.stopPropagation(); return confirm('Are you sure? This will delete the job and all associated applications.');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                        <tr id="job-details-{{ job.id }}" class="hidden bg-gray-900/30 border-b border-white/5">
                            <td colspan="4" class="px-6 py-4 text-gray-300">
                                <div class="mb-4">
                                    <strong class="block text-xs uppercase text-gray-500 mb-1">Description</strong>
                                    <p class="text-sm">{{ job.description }}</p>
                                </div>
                                <div>
                                    <strong class="block text-xs uppercase text-gray-500 mb-2">Applicants ({{ job.applications|length }})</strong>
                                    {% if job.applications %}
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                            {% for app in job.applications %}
                                                <div class="flex justify-between items-center bg-black/20 p-2 rounded text-xs">
                                                    <span>{{ app.candidate.username }}</span>
                                                    <span class="uppercase text-[10px] font-bold 
                                                        {% if app.status == 'accepted' %}text-green-400{% elif app.status == 'rejected' %}text-red-400{% else %}text-yellow-400{% endif %}">
                                                        {{ app.status }}
                                                    </span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-xs text-gray-500 italic">No applications received yet.</p>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">No job openings found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="feedback-panel" class="tab-panel hidden p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3">Candidate</th>
                            <th class="px-4 py-3">Moderator</th>
                            <th class="px-4 py-3">Date</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for f in feedback %}
                        <tr class="hover:bg-white/5 transition-colors cursor-pointer group" onclick="toggleDetails('feedback-details-{{ f.id }}')">
                            <td class="px-4 py-4 font-medium text-white">{{ f.candidate.username }}</td>
                            <td class="px-4 py-4 text-gray-300">{{ f.moderator.username }}</td>
                            <td class="px-4 py-4 text-gray-400">{{ f.created_at.strftime('%b %d, %Y') }}</td>
                            <td class="px-4 py-4 text-right">
                                <a href="{{ url_for('admin.delete_feedback', feedback_id=f.id) }}" class="text-gray-500 hover:text-red-400 transition-colors p-2" title="Delete" onclick="event.stopPropagation(); return confirm('Are you sure?');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                        <tr id="feedback-details-{{ f.id }}" class="hidden bg-gray-900/30 border-b border-white/5">
                            <td colspan="4" class="px-6 py-4 text-gray-300">
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4 text-xs text-center">
                                    <div class="bg-black/20 p-2 rounded">
                                        <span class="block text-gray-500">Correctness</span>
                                        <span class="font-bold text-lg text-indigo-400">{{ f.code_correctness }}/5</span>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded">
                                        <span class="block text-gray-500">Efficiency</span>
                                        <span class="font-bold text-lg text-indigo-400">{{ f.code_efficiency }}/5</span>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded">
                                        <span class="block text-gray-500">Readability</span>
                                        <span class="font-bold text-lg text-indigo-400">{{ f.code_readability }}/5</span>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded">
                                        <span class="block text-gray-500">Problem Solving</span>
                                        <span class="font-bold text-lg text-indigo-400">{{ f.problem_solving }}/5</span>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded">
                                        <span class="block text-gray-500">Time Mgmt</span>
                                        <span class="font-bold text-lg text-indigo-400">{{ f.time_management }}/5</span>
                                    </div>
                                </div>
                                <div>
                                    <strong class="block text-xs uppercase text-gray-500 mb-1">Remarks</strong>
                                    <p class="text-sm bg-black/20 p-3 rounded text-gray-300">{{ f.remarks or 'No additional remarks.' }}</p>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">No feedback records found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="submissions-panel" class="tab-panel hidden p-6">
             <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3">Candidate</th>
                            <th class="px-4 py-3">Language</th>
                            <th class="px-4 py-3">Submitted To</th>
                            <th class="px-4 py-3">Date</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for sub in submissions %}
                        <tr class="hover:bg-white/5 transition-colors cursor-pointer group" onclick="toggleDetails('sub-details-{{ sub.id }}')">
                            <td class="px-4 py-4 font-medium text-white">{{ sub.candidate_submitter.username }}</td>
                            <td class="px-4 py-4 text-gray-300">{{ sub.language|title }}</td>
                            <td class="px-4 py-4 text-gray-400">{{ sub.test_recipient.username }}</td>
                            <td class="px-4 py-4 text-gray-400">{{ sub.submitted_at.strftime('%b %d, %Y') }}</td>
                            <td class="px-4 py-4 text-right">
                                <a href="{{ url_for('admin.delete_submission_record', submission_id=sub.id) }}" class="text-gray-500 hover:text-red-400 transition-colors p-2" title="Delete" onclick="event.stopPropagation(); return confirm('Are you sure?');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                        <tr id="sub-details-{{ sub.id }}" class="hidden bg-gray-900/30 border-b border-white/5">
                            <td colspan="5" class="px-6 py-4">
                                <div class="mb-3">
                                    <strong class="block text-xs uppercase text-gray-500 mb-1">Source Code</strong>
                                    <pre class="bg-black/40 p-3 rounded text-xs font-mono text-gray-300 overflow-x-auto custom-scrollbar max-h-40">{{ sub.code }}</pre>
                                </div>
                                <div>
                                    <strong class="block text-xs uppercase text-gray-500 mb-1">Output</strong>
                                    <pre class="bg-black/40 p-3 rounded text-xs font-mono text-green-400 overflow-x-auto custom-scrollbar max-h-24">{{ sub.output or 'No output recorded.' }}</pre>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">No submissions found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="history-panel" class="tab-panel hidden p-6">
             <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3">Candidate</th>
                            <th class="px-4 py-3">Moderator</th>
                            <th class="px-4 py-3">Problem</th>
                            <th class="px-4 py-3">Assigned Date</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for record in history %}
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-4 py-4 font-medium text-white">{{ record.candidate.username }}</td>
                            <td class="px-4 py-4 text-gray-300">{{ record.moderator.username }}</td>
                            <td class="px-4 py-4 text-gray-400">{{ record.problem.title }}</td>
                            <td class="px-4 py-4 text-gray-400">{{ record.assigned_at.strftime('%b %d, %Y') }}</td>
                            <td class="px-4 py-4 text-right">
                                <a href="{{ url_for('admin.delete_assignment_history', history_id=record.id) }}" class="text-gray-500 hover:text-red-400 transition-colors p-2" title="Delete" onclick="return confirm('Are you sure?');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">No assignment history found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="events-panel" class="tab-panel hidden p-6">
             <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3">Candidate</th>
                            <th class="px-4 py-3">Problem</th>
                            <th class="px-4 py-3">Moderator</th>
                            <th class="px-4 py-3">Completion Date</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for event in events %}
                            <tr class="hover:bg-white/5 transition-colors cursor-pointer group" onclick="toggleDetails('event-details-{{ event.id }}')">
                                <td class="px-4 py-4 font-medium text-white">{{ event.username }}</td>
                                <td class="px-4 py-4 text-gray-300">{{ event.assigned_problem.title }}</td>
                                <td class="px-4 py-4 text-gray-400">
                                    {% if event.moderator_id and moderators_map.get(event.moderator_id) %}
                                        {{ moderators_map.get(event.moderator_id).username }}
                                    {% else %}
                                        <span class="text-gray-600">None</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-gray-400">{{ event.test_end_time.strftime('%b %d, %Y') if event.test_end_time else 'N/A' }}</td>
                                <td class="px-4 py-4 text-right">
                                    <a href="{{ url_for('admin.delete_coding_event', user_id=event.id) }}" class="text-gray-500 hover:text-red-400 transition-colors p-2" title="Clear Event History" onclick="event.stopPropagation(); return confirm('Are you sure? This clears the event history for this user.');">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </td>
                            </tr>
                            <tr id="event-details-{{ event.id }}" class="hidden bg-gray-900/30 border-b border-white/5">
                                <td colspan="5" class="px-6 py-4">
                                    <strong class="block text-xs uppercase text-gray-500 mb-1">Submitted Code (Preview)</strong>
                                    {% set submissions_list = event.test_submissions.all() %}
                                    {% if submissions_list %}
                                        {% set submission = submissions_list | sort(attribute='submitted_at', reverse=True) | first %}
                                        <pre class="bg-black/40 p-3 rounded text-xs font-mono text-gray-300 overflow-x-auto custom-scrollbar max-h-40">{{ submission.code }}</pre>
                                    {% else %}
                                        <p class="text-xs text-gray-500 italic">No code submission recorded for this event.</p>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">No completed events found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    function toggleDetails(rowId) {
        const row = document.getElementById(rowId);
        if(row) {
            row.classList.toggle('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // (Tab Logic remains same)
        const tabs = document.querySelectorAll('.tab-link');
        const panels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('text-indigo-400', 'border-indigo-500', 'active');
                    t.classList.add('text-gray-400', 'border-transparent');
                });
                tab.classList.add('text-indigo-400', 'border-indigo-500', 'active');
                tab.classList.remove('text-gray-400', 'border-transparent');
                panels.forEach(panel => panel.classList.add('hidden'));
                const targetId = tab.getAttribute('data-target');
                const targetPanel = document.getElementById(targetId);
                if(targetPanel) {
                    targetPanel.classList.remove('hidden');
                    gsap.fromTo(targetPanel, {opacity: 0, y: 10}, {opacity: 1, y: 0, duration: 0.3});
                }
            });
        });
    });
</script>
{% endblock %}