{% extends "layout.html" %}
{% block title %}Manage Records{% endblock %}
{% block content %}
<div class="animate-dynamic">
    <h1 class="text-3xl font-bold text-white mb-6">Manage Historical Records</h1>

    <div class="mb-6">
        <div class="border-b border-gray-700">
            <nav id="records-tabs" class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                <a href="#" class="tab-link border-indigo-500 text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="jobs">Job Openings</a>
                <a href="#" class="tab-link border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="feedback">Candidate Feedback</a>
                <a href="#" class="tab-link border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="submissions">Code Submissions</a>
                <a href="#" class="tab-link border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="history">Assignment History</a>
                <a href="#" class="tab-link border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="events">Coding Events</a>
            </nav>
        </div>
    </div>

    <div id="records-content">
        <!-- Job Openings Tab -->
        <div id="jobs-tab" class="tab-content">
            <div class="bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 backdrop-blur-sm border border-white/10">
                <h2 class="text-2xl font-bold text-white mb-4">All Job Openings</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="border-b border-white/20">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Title</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Created On</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in jobs %}
                            <tr class="cursor-pointer hover:bg-gray-700/20 border-b border-white/10" onclick="toggleDetails('job-{{ loop.index }}')">
                                <td class="py-4 px-4 text-sm text-white">{{ job.title }}</td>
                                <td class="py-4 px-4 text-sm">
                                    {% if job.is_open %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Open</span>{% else %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Closed</span>{% endif %}
                                </td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ job.created_at.strftime('%b %d, %Y') }}</td>
                                <td class="py-4 px-4 text-sm">
                                    <a href="{{ url_for('delete_job_opening', job_id=job.id) }}" class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); return confirm('Are you sure? This will delete the job and all associated applications.');">Delete</a>
                                </td>
                            </tr>
                            <tr id="job-{{ loop.index }}" class="hidden">
                                <td colspan="4" class="p-6 bg-gray-800/50">
                                    <h4 class="font-semibold text-white mb-2">Job Description:</h4>
                                    <p class="text-gray-300 whitespace-pre-wrap mb-6">{{ job.description }}</p>
                                    
                                    <h4 class="font-semibold text-white mb-2">Applicants:</h4>
                                    {% if job.applications %}
                                        <table class="min-w-full text-sm">
                                            <thead class="border-b border-white/10">
                                                <tr>
                                                    <th class="py-2 px-2 text-left font-medium text-gray-300">Candidate Name</th>
                                                    <th class="py-2 px-2 text-left font-medium text-gray-300">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for app in job.applications %}
                                                <tr class="border-b border-gray-700/50">
                                                    <td class="py-2 px-2 text-gray-200">{{ app.candidate.username }}</td>
                                                    <td class="py-2 px-2 text-gray-200">
                                                        <span class="px-2 py-1 text-xs font-semibold rounded-full 
                                                            {% if app.status == 'pending' %}text-yellow-800 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-200{% endif %}
                                                            {% if app.status == 'accepted' %}text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-200{% endif %}
                                                            {% if app.status == 'rejected' %}text-red-800 bg-red-100 dark:bg-red-900 dark:text-red-200{% endif %}">
                                                            {{ app.status.title() }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% else %}
                                        <p class="text-gray-400">No candidates have applied for this job yet.</p>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="py-4 text-center text-gray-400">No job openings found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Feedback Tab -->
        <div id="feedback-tab" class="tab-content hidden">
            <div class="bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 backdrop-blur-sm border border-white/10">
                <h2 class="text-2xl font-bold text-white mb-4">All Candidate Feedback</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                         <thead class="border-b border-white/20">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Candidate</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Moderator</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in feedback %}
                            <tr class="cursor-pointer hover:bg-gray-700/20 border-b border-white/10" onclick="toggleDetails('feedback-{{ loop.index }}')">
                                <td class="py-4 px-4 text-sm text-white">{{ f.candidate.username }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ f.moderator.username }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ f.created_at.strftime('%b %d, %Y') }}</td>
                                <td class="py-4 px-4 text-sm">
                                     <a href="{{ url_for('delete_feedback', feedback_id=f.id) }}" class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); return confirm('Are you sure?');">Delete</a>
                                </td>
                            </tr>
                            <tr id="feedback-{{ loop.index }}" class="hidden bg-gray-800/30">
                                <td colspan="4" class="p-4 text-gray-300">
                                    <h4 class="font-semibold text-white mb-2">Detailed Ratings:</h4>
                                    <ul class="list-disc list-inside space-y-1 mb-4">
                                        <li>Code Correctness: <span class="font-bold">{{ f.code_correctness }}/5</span></li>
                                        <li>Code Efficiency: <span class="font-bold">{{ f.code_efficiency }}/5</span></li>
                                        <li>Code Readability: <span class="font-bold">{{ f.code_readability }}/5</span></li>
                                        <li>Problem Solving: <span class="font-bold">{{ f.problem_solving }}/5</span></li>
                                        <li>Time Management: <span class="font-bold">{{ f.time_management }}/5</span></li>
                                    </ul>
                                    <h4 class="font-semibold text-white mb-2">Remarks:</h4>
                                    <p class="whitespace-pre-wrap">{{ f.remarks or 'No remarks provided.' }}</p>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="py-4 text-center text-gray-400">No feedback records found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Code Submissions Tab -->
        <div id="submissions-tab" class="tab-content hidden">
             <div class="bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 backdrop-blur-sm border border-white/10">
                <h2 class="text-2xl font-bold text-white mb-4">All Code Submissions</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="border-b border-white/20">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Candidate</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Recipient</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in submissions %}
                            <tr class="cursor-pointer hover:bg-gray-700/20 border-b border-white/10" onclick="toggleDetails('sub-{{ loop.index }}')">
                                <td class="py-4 px-4 text-sm text-white">{{ sub.candidate_submitter.username }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ sub.test_recipient.username }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ sub.submitted_at.strftime('%b %d, %Y') }}</td>
                                <td class="py-4 px-4 text-sm">
                                    <a href="{{ url_for('delete_submission_record', submission_id=sub.id) }}" class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); return confirm('Are you sure?');">Delete</a>
                                </td>
                            </tr>
                            <tr id="sub-{{ loop.index }}" class="hidden bg-gray-800/30">
                                <td colspan="4" class="p-4">
                                    <h4 class="font-semibold text-white mb-2">Submitted Code ({{ sub.language }}):</h4>
                                    <pre><code class="language-{{ sub.language }}">{{ sub.code }}</code></pre>
                                    <h4 class="font-semibold text-white mt-4 mb-2">Console Output:</h4>
                                    <pre class="bg-gray-900 rounded p-2 text-white"><code>{{ sub.output or 'No output recorded.' }}</code></pre>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="py-4 text-center text-gray-400">No submissions found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Assignment History Tab -->
        <div id="history-tab" class="tab-content hidden">
            <div class="bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 backdrop-blur-sm border border-white/10">
                <h2 class="text-2xl font-bold text-white mb-4">Moderator Assignment History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="border-b border-white/20">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Candidate</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Assigned Moderator</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Coding Event</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Date Assigned</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in history %}
                            <tr class="border-b border-white/10">
                                <td class="py-4 px-4 text-sm text-white">{{ record.candidate.username }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ record.moderator.username }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ record.problem.title }}</td>
                                <td class="py-4 px-4 text-sm text-gray-300">{{ record.assigned_at.strftime('%b %d, %Y') }}</td>
                                <td class="py-4 px-4 text-sm">
                                    <a href="{{ url_for('delete_assignment_history', history_id=record.id) }}" class="text-red-500 hover:text-red-700" onclick="return confirm('Are you sure?');">Delete</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="py-4 text-center text-gray-400">No assignment history found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Coding Events Tab -->
        <div id="events-tab" class="tab-content hidden">
             <div class="bg-white/5 dark:bg-gray-800/20 rounded-lg shadow-xl p-6 backdrop-blur-sm border border-white/10">
                <h2 class="text-2xl font-bold text-white mb-4">Completed Coding Events</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="border-b border-white/20">
                             <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Event (Problem)</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Candidate</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Moderator</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Completed On</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events %}
                                <tr class="cursor-pointer hover:bg-gray-700/20 border-b border-white/10" onclick="toggleDetails('event-{{ loop.index }}')">
                                    <td class="py-4 px-4 text-sm text-white">{{ event.assigned_problem.title }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ event.username }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ moderators_map.get(event.moderator_id).username if event.moderator_id and moderators_map.get(event.moderator_id) else 'N/A' }}</td>
                                    <td class="py-4 px-4 text-sm text-gray-300">{{ event.test_end_time.strftime('%b %d, %Y') }}</td>
                                    <td class="py-4 px-4 text-sm">
                                        <a href="{{ url_for('delete_coding_event', user_id=event.id) }}" class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); return confirm('Are you sure? This clears the event history for this user.');">Delete</a>
                                    </td>
                                </tr>
                                <tr id="event-{{ loop.index }}" class="hidden bg-gray-800/30">
                                    <td colspan="5" class="p-4">
                                        <h4 class="font-semibold text-white mb-2">Submitted Code:</h4>
                                        {% set submission = event.test_submissions.first() %}
                                        {% if submission %}
                                            <pre><code class="language-java">{{ submission.code }}</code></pre>
                                        {% else %}
                                            <p class="text-gray-400">No code was submitted for this event.</p>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% else %}
                                <tr><td colspan="5" class="py-4 text-center text-gray-400">No completed coding events found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDetails(rowId) {
        const row = document.getElementById(rowId);
        row.classList.toggle('hidden');
        // If we are showing a row with code, re-run the syntax highlighter
        if (!row.classList.contains('hidden')) {
            Prism.highlightAll();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                
                tabs.forEach(t => {
                    t.classList.remove('border-indigo-500', 'text-indigo-400');
                    t.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
                });
                
                tab.classList.add('border-indigo-500', 'text-indigo-400');
                tab.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');

                const targetTab = tab.dataset.tab;
                tabContents.forEach(content => {
                    if (content.id === `${targetTab}-tab`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
                // Re-highlight code after tab switch
                if (targetTab === 'events' || targetTab === 'submissions') {
                    Prism.highlightAll();
                }
            });
        });
    });
</script>
{% endblock %}

