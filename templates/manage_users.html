{% extends "layout.html" %}
{% block title %}Manage Users{% endblock %}
{% block content %}

<div class="animate-dynamic">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-white tracking-tight">User Management</h1>
            <p class="text-gray-400 mt-1 text-sm"> oversee platform access and user roles.</p>
        </div>
        <button id="createUserBtn" class="flex items-center justify-center px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white font-medium rounded-lg shadow-lg shadow-indigo-500/30 transition-all transform hover:scale-105">
            <i class="fas fa-user-plus mr-2"></i> Add New User
        </button>
    </div>

    <div class="bg-white/5 dark:bg-gray-800/40 rounded-xl p-4 mb-6 border border-white/10 backdrop-blur-md flex flex-col md:flex-row gap-4 justify-between items-center">
        <div class="relative w-full md:w-96 group">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 group-focus-within:text-indigo-400 transition-colors">
                <i class="fas fa-search"></i>
            </div>
            <input type="text" id="searchInput" placeholder="Search users by name or email..." 
                class="block w-full pl-10 pr-3 py-2.5 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all text-sm">
        </div>
        <div class="flex gap-4 w-full md:w-auto">
            <div class="relative w-full md:w-40">
                <select id="filter-role" class="block w-full pl-3 pr-8 py-2.5 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                    <option value="all">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="developer">Developer</option>
                    <option value="moderator">Moderator</option>
                    <option value="candidate">Candidate</option>
                    <option value="buyer">Buyer</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>
            <div class="relative w-full md:w-40">
                <select id="filter-status" class="block w-full pl-3 pr-8 py-2.5 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white/5 dark:bg-gray-800/20 rounded-xl shadow-xl border border-white/10 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full text-left">
                <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold tracking-wider border-b border-white/10">
                    <tr>
                        <th class="px-6 py-4">User Profile</th>
                        <th class="px-6 py-4">Role</th>
                        <th class="px-6 py-4 text-center">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="user-table-body" class="divide-y divide-white/5">
                    {% for user in users %}
                    <tr class="hover:bg-white/5 transition-colors user-row group" data-role="{{ user.role }}" data-status="{% if user.is_active %}active{% else %}inactive{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full border border-gray-600 object-cover" src="{{ user.avatar_url }}" alt="">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-white user-name">{{ user.username }}</div>
                                    <div class="text-xs text-gray-400 user-email">{{ user.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium border 
                                {% if user.role == 'admin' %} bg-purple-900/30 text-purple-300 border-purple-700
                                {% elif user.role == 'developer' %} bg-blue-900/30 text-blue-300 border-blue-700
                                {% elif user.role == 'moderator' %} bg-orange-900/30 text-orange-300 border-orange-700
                                {% elif user.role == 'buyer' %} bg-green-900/30 text-green-300 border-green-700
                                {% else %} bg-gray-800 text-gray-300 border-gray-600 {% endif %}">
                                {{ user.role|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            {% if user.is_active %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full mr-1.5"></span> Active
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-500/10 text-red-400 border border-red-500/20">
                                    <span class="w-1.5 h-1.5 bg-red-400 rounded-full mr-1.5"></span> Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-3 opacity-80 group-hover:opacity-100 transition-opacity">
                                <a href="{{ url_for('admin.view_profile', user_id=user.id) }}" class="text-indigo-400 hover:text-indigo-300 bg-indigo-500/10 p-2 rounded-lg hover:bg-indigo-500/20 transition-colors" title="View Profile">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user.id != current_user.id %}
                                    <a href="{{ url_for('admin.toggle_user_status', user_id=user.id) }}" class="p-2 rounded-lg transition-colors {% if user.is_active %}text-red-400 hover:text-red-300 bg-red-500/10 hover:bg-red-500/20{% else %}text-green-400 hover:text-green-300 bg-green-500/10 hover:bg-green-500/20{% endif %}" 
                                       title="{% if user.is_active %}Deactivate User{% else %}Activate User{% endif %}">
                                        <i class="fas fa-power-off"></i>
                                    </a>
                                {% else %}
                                    <span class="p-2 text-gray-600 cursor-not-allowed" title="Cannot deactivate yourself"><i class="fas fa-power-off"></i></span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="no-results" class="hidden py-12 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-800 mb-4">
                <i class="fas fa-search text-gray-500 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-white">No users found</h3>
            <p class="text-gray-400 text-sm mt-1">Try adjusting your search or filters.</p>
        </div>
    </div>
</div>

<div id="createUserModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-black/80 transition-opacity backdrop-blur-sm" aria-hidden="true" id="modalOverlay"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-gray-900 rounded-2xl text-left overflow-hidden shadow-2xl border border-white/10 transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-gray-900 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-900/50 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-user-plus text-indigo-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-bold text-white" id="modal-title">Create New User</h3>
                        <div class="mt-4">
                            <form id="createUserForm" action="{{ url_for('admin.create_user') }}" method="POST" class="space-y-4">
                                <div>
                                    <label for="username" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Username</label>
                                    <input type="text" name="username" id="username" required class="block w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent placeholder-gray-600" placeholder="jdoe">
                                </div>
                                <div>
                                    <label for="email" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Email Address</label>
                                    <input type="email" name="email" id="email" required class="block w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent placeholder-gray-600" placeholder="name@company.com">
                                </div>
                                <div>
                                    <label for="password" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Password</label>
                                    <input type="password" name="password" id="password" required class="block w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent placeholder-gray-600" placeholder="••••••••">
                                </div>
                                <div>
                                    <label for="role" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Role</label>
                                    <select name="role" id="role" class="block w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none cursor-pointer">
                                        <option value="candidate">Candidate</option>
                                        <option value="developer">Developer</option>
                                        <option value="moderator">Moderator</option>
                                        <option value="buyer">Buyer</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-white/5">
                <button type="submit" form="createUserForm" id="createUserBtnAction" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors">
                    Create User
                </button>
                <button type="button" id="cancelCreateUser" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-600 shadow-sm px-4 py-2 bg-transparent text-base font-medium text-gray-300 hover:bg-gray-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // (Existing script content for search, filter, and modal toggle)
        const searchInput = document.getElementById('searchInput');
        const roleFilter = document.getElementById('filter-role');
        const statusFilter = document.getElementById('filter-status');
        const userRows = document.querySelectorAll('.user-row');
        const noResults = document.getElementById('no-results');

        function filterUsers() {
            const query = searchInput.value.toLowerCase();
            const selectedRole = roleFilter.value;
            const selectedStatus = statusFilter.value;
            let visibleCount = 0;

            userRows.forEach(row => {
                const name = row.querySelector('.user-name').textContent.toLowerCase();
                const email = row.querySelector('.user-email').textContent.toLowerCase();
                const userRole = row.dataset.role;
                const userStatus = row.dataset.status;

                const matchesSearch = name.includes(query) || email.includes(query);
                const matchesRole = selectedRole === 'all' || userRole === selectedRole;
                const matchesStatus = selectedStatus === 'all' || userStatus === selectedStatus;

                if (matchesSearch && matchesRole && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (visibleCount === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }
        }

        searchInput.addEventListener('keyup', filterUsers);
        roleFilter.addEventListener('change', filterUsers);
        statusFilter.addEventListener('change', filterUsers);

        // Modal functionality
        const createUserBtn = document.getElementById('createUserBtn');
        const createUserModal = document.getElementById('createUserModal');
        const cancelCreateUserBtn = document.getElementById('cancelCreateUser');
        const modalOverlay = document.getElementById('modalOverlay');
        const createUserForm = document.getElementById('createUserForm');
        const createUserBtnAction = document.getElementById('createUserBtnAction');

        function toggleModal(show) {
            if(show) {
                createUserModal.classList.remove('hidden');
                createUserModal.querySelector('div[class*="transform"]').classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                createUserModal.querySelector('div[class*="transform"]').classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
            } else {
                createUserModal.classList.add('hidden');
            }
        }

        createUserBtn.addEventListener('click', () => toggleModal(true));
        cancelCreateUserBtn.addEventListener('click', () => toggleModal(false));
        modalOverlay.addEventListener('click', () => toggleModal(false));

        createUserForm.addEventListener('submit', () => {
            createUserBtnAction.disabled = true;
            createUserBtnAction.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Creating...`;
        });
    });
</script>
{% endblock %}