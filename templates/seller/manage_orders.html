{% extends "layout.html" %}
{% block title %}Manage Orders{% endblock %}
{% block content %}
<div class="space-y-8 animate-dynamic pb-10">
    <div class="flex justify-between items-center bg-white/5 border border-white/5 rounded-2xl p-4 backdrop-blur-xl shadow-lg">
        <h1 class="text-4xl font-extrabold text-white flex items-center gap-3">
            <i class="fas fa-shopping-cart text-indigo-400"></i> Order Management
        </h1>
        <button onclick="document.getElementById('createOrderModal').classList.remove('hidden')" class="px-6 py-2.5 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-lg shadow-green-500/20 transition-all flex items-center">
            <i class="fas fa-plus mr-2"></i> Create Order
        </button>
    </div>

    <div id="ordersContainer" class="space-y-3">
        {% for order in orders %}
        <div class="glass-panel rounded-xl p-5 border border-white/5 flex flex-wrap gap-4 items-center justify-between hover:bg-white/[0.03] transition-all">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-indigo-500/10 flex items-center justify-center text-indigo-400 font-bold">
                    #
                </div>
                <div>
                    <span class="block text-sm font-bold text-white">{{ order.order_number }}</span>
                    <span class="text-xs text-gray-500 flex items-center gap-1">
                        <i class="fas fa-user-circle"></i> {{ order.buyer.username }}
                    </span>
                </div>
            </div>
            
            <div class="text-right">
                 <span class="block text-sm font-bold text-white">₹{{ "{:,.2f}".format(order.total_amount) }}</span>
                 <span class="text-xs text-gray-500">{{ order.created_at.strftime('%b %d, %Y') }}</span>
            </div>

            <div class="flex items-center gap-3">
                <form action="{{ url_for('seller.update_order_status', order_id=order.id) }}" method="POST">
                    <select name="status" onchange="this.form.submit()" 
                            class="bg-black/40 border border-white/10 text-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 transition-all cursor-pointer {{ 'text-green-400' if order.status == 'Order Delivered' else 'text-yellow-400' }}">
                        <option value="Order Placed" {% if order.status == 'Order Placed' %}selected{% endif %}>Placed</option>
                        <option value="Order Accepted" {% if order.status == 'Order Accepted' %}selected{% endif %}>Accept</option>
                        <option value="Order Dispatched" {% if order.status == 'Order Dispatched' %}selected{% endif %}>Dispatch</option>
                        <option value="Order Delivered" {% if order.status == 'Order Delivered' %}selected{% endif %}>Delivered</option>
                    </select>
                </form>
            </div>
        </div>
        {% else %}
        <div class="glass-panel p-12 rounded-xl text-center border-dashed border-2 border-white/10">
            <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-500">
                <i class="fas fa-clipboard-list text-3xl"></i>
            </div>
            <h3 class="text-lg font-bold text-white">No Orders Yet</h3>
            <p class="text-gray-400 text-sm mt-1">Orders assigned to you will appear here.</p>
        </div>
        {% endfor %}
    </div>
</div>

<div id="createOrderModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="document.getElementById('createOrderModal').classList.add('hidden')"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        
        <div class="inline-block align-middle bg-[#0f172a] rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-3xl sm:w-full border border-white/10">
            <form action="{{ url_for('seller.create_order') }}" method="POST" class="flex flex-col h-full">
                <div class="px-6 py-4 border-b border-white/10 bg-white/5 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-cart-plus text-green-400"></i> Create New Order
                    </h3>
                    <button type="button" onclick="document.getElementById('createOrderModal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="px-6 py-6 space-y-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Select Buyer</label>
                            <select name="buyer_id" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Choose Customer --</option>
                                {% for buyer in buyers %}
                                    <option value="{{ buyer.id }}">{{ buyer.username }} ({{ buyer.email }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Shipping Address</label>
                            <textarea name="shipping_address" required rows="1" placeholder="Full address" class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>

                    <hr class="border-white/10">

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase">Order Items</label>
                            <button type="button" onclick="addItemRow()" class="text-xs text-indigo-400 hover:text-indigo-300 font-bold flex items-center">
                                <i class="fas fa-plus-circle mr-1"></i> Add Item
                            </button>
                        </div>
                        
                        <div id="items-container" class="space-y-3">
                            <div class="item-row flex gap-3">
                                <select name="product_id[]" required class="flex-1 px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-white text-sm">
                                    <option value="">-- Select Product --</option>
                                    {% for p in products %}
                                        <option value="{{ p.id }}" data-price="{{ p.price }}">
                                            {{ p.name }} (Stock: {{ p.stock }}) - ₹{{ p.price }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <input type="number" name="quantity[]" value="1" min="1" required placeholder="Qty" class="w-24 px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-white text-sm">
                                <button type="button" onclick="this.closest('.item-row').remove()" class="text-red-400 hover:text-red-300 px-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 bg-black/20 border-t border-white/10 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('createOrderModal').classList.add('hidden')" class="px-4 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 transition-all text-sm font-medium">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-500/20 transition-all text-sm font-bold">Create Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function addItemRow() {
        const container = document.getElementById('items-container');
        const firstRow = container.querySelector('.item-row');
        const newRow = firstRow.cloneNode(true);
        
        // Reset values
        newRow.querySelector('select').value = "";
        newRow.querySelector('input').value = "1";
        
        container.appendChild(newRow);
    }
</script>
{% endblock %}